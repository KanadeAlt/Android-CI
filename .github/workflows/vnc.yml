name: noVNC RDP

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Desktop + PulseAudio + Mesa (llvmpipe)
        run: |
          sudo apt update
          sudo apt install -y \
            lxde x11vnc xvfb x11-xserver-utils \
            pulseaudio ffmpeg curl wget git \
            libopus0 \
            mesa-utils \
            libgl1 \
            libglx-mesa0 \
            mesa-va-drivers \
            mesa-vulkan-drivers \
            libegl1 \
            libegl-mesa0 \
            libgbm1

          pulseaudio --start

      - name: Download WebRTC Streamer (binary)
        run: |
          wget -q https://github.com/mpromonet/webrtc-streamer/releases/latest/download/webrtc-streamer_x86_64.AppImage
          chmod +x webrtc-streamer_x86_64.AppImage
          mv webrtc-streamer_x86_64.AppImage /usr/local/bin/webrtc-streamer

      - name: Enable llvmpipe Rendering
        run: |
          echo "DISPLAY=:1" >> $GITHUB_ENV
          echo "MESA_LOADER_DRIVER_OVERRIDE=llvmpipe" >> $GITHUB_ENV
          echo "GALLIUM_DRIVER=llvmpipe" >> $GITHUB_ENV
          echo "LIBGL_ALWAYS_SOFTWARE=1" >> $GITHUB_ENV

      - name: Start Xvfb + LXDE + x11vnc
        run: |
          export DISPLAY=:1
          Xvfb :1 -screen 0 1280x720x24 -ac +extension RANDR &
          sleep 3
          startlxde &
          sleep 3
          x11vnc -display :1 -nopw -forever -shared -quiet &
          sleep 2

      - name: Start WebRTC Streamer (60FPS + VP9 LowDelay)
        run: |
          export DISPLAY=:1
          webrtc-streamer \
            -H 8000 \
            -C "\"pulse\"" \
            -a default \
            --video-encoder=vp9 \
            --video-min-bitrate=2000 \
            --video-max-bitrate=12000 \
            --nack=1 \
            --fec=0 \
            --dtls=1 \
            --rtcp-mux=1 \
            --disable-audio-jitter-buffer \
            --disable-noise-suppression \
            --disable-agc \
            --disable-gain-control \
            --no-drop \
            -V "x11grab?framerate=75&draw_mouse=1&use_rw=1" \
            --size=0x0 \
            > webrtc.log 2>&1 &

          sleep 5
          echo "WebRTC Streamer started."

      - name: Install Cloudflared
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Expose WebRTC public URL
        run: |
          cloudflared tunnel --url http://localhost:8000 --no-autoupdate > log.txt 2>&1 &
          sleep 12
          echo "======================================="
          echo " PUBLIC WebRTC DESKTOP 60FPS VP9 URL"
          grep -o 'https://.*trycloudflare.com' log.txt
          echo "======================================="
          tail -f /dev/null
