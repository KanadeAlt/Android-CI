name: macOS noVNC

on:
  workflow_dispatch:

jobs:
  macos-novnc:
    runs-on: macos-13

    steps:
      - name: Install dependencies (brew)
        run: |
          brew install npm
          brew install --cask ngrok
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1

      - name: Enable VNC & Create user
        run: |
          echo "[+] Creating VNC user"
          sudo sysadminctl -addUser vncuser -password password -admin

          echo "[+] Enable Remote Management (VNC server)"
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw password \
            -restart -agent -privs -all

          echo "[+] Enable ScreenSharing"
          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist \
            com.apple.screensharing -dict Disabled -bool false

          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist || true

      - name: Download noVNC + WebSockify
        run: |
          git clone https://github.com/novnc/noVNC.git
          git clone https://github.com/novnc/websockify.git
          cd websockify
          npm install

      - name: Start WebSockify (VNC â†’ WebSocket)
        run: |
          cd websockify
          nohup node websockify.js 6080 localhost:5900 &
          sleep 3

      - name: Start noVNC server
        run: |
          cd noVNC
          nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      - name: Start ngrok tunnel (HTTP)
        run: |
          echo "$NGROK_AUTHTOKEN" | ngrok config add-authtoken -
          ngrok http 6080 > ngrok.log &
          sleep 5

      - name: Show public noVNC URL
        run: |
          echo "noVNC URL:"
          grep -Eo "https://[0-9a-z\-]*\.ngrok.io" ngrok.log | head -n 1

      - name: Keep session alive
        run: sleep 36000
