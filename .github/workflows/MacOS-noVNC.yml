name: macOS noVNC

on:
  workflow_dispatch:

jobs:
  macos-vnc:
    runs-on: macos-13

    steps:
      - name: Prepare noVNC + websockify
        run: |
          brew install python
          pip3 install websockify
          git clone https://github.com/novnc/noVNC.git

      - name: Create macOS VNC user
        run: |
          sudo sysadminctl -addUser vncuser -password password -admin

      - name: Enable macOS Screen Sharing (REAL macOS desktop)
        run: |
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
            -activate -configure -access -on \
            -clientopts -setvnclegacy -vnclegacy yes \
            -clientopts -setvncpw -vncpw password \
            -restart -agent -privs -all

          sudo defaults write /var/db/launchd.db/com.apple.launchd/overrides.plist \
            com.apple.screensharing -dict Disabled -bool false
          
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist || true

      - name: Start Websockify (VNC â†’ WebSocket)
        run: |
          nohup websockify --web noVNC 6080 localhost:5900 &
          sleep 3

      - name: Install cloudflared
        run: |
          brew install cloudflared

      - name: Start Cloudflare Tunnel
        run: |
          nohup cloudflared tunnel --url http://localhost:6080 > tunnel.log &
          sleep 5

      - name: Print Auto-Login noVNC URL
        run: |
          URL=$(grep -Eo "https://.*trycloudflare.com" tunnel.log | head -n 1)
          echo "=============================="
          echo " AUTO-LOGIN macOS GUI URL"
          echo "=============================="
          echo "$URL/vnc.html?password=password"
          echo "=============================="

      - name: Keep alive
        run: sleep 36000
