name: Windows RDP + Cloudflare Tunnel (6 Hours)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    - name: Set RDP Password
      run: net user runneradmin "Password123!"
      shell: powershell

    - name: Enable Windows RDP
      run: |
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name fDenyTSConnections -Value 0
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name UserAuthentication -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
      shell: powershell

    - name: Install Chrome
      run: choco install googlechrome -y
      shell: powershell

    - name: Install cloudflared
      run: choco install cloudflared -y
      shell: powershell

    - name: Start Cloudflare Tunnel (background job)
      run: |
        $log="$env:USERPROFILE\.cloudflared\cf.log"

        Start-Job -ScriptBlock {
          cloudflared tunnel --url rdp://localhost:3389 `
            --logfile "$env:USERPROFILE\.cloudflared\cf.log" `
            --loglevel info
        }

        # tunggu tunnel start
        Start-Sleep -Seconds 10
      shell: powershell

    - name: Print Tunnel URL
      run: |
        $log="$env:USERPROFILE\.cloudflared\cf.log"

        echo "======================================"
        echo " Cloudflare Tunnel URL:"
        echo "======================================"

        if (Test-Path $log) {
          $line = (Get-Content $log -Tail 50 | Select-String "trycloudflare")[-1]
          echo $line
        } else {
          echo "Log file not found!"
        }

        echo ""
        echo "RDP Login:"
        echo "  User: runneradmin"
        echo "  Pass: Password123!"
        echo ""
        echo "Runner stays alive for 6 hours..."
      shell: powershell

    - name: Keep Alive 6 Hours
      run: |
        for ($i=0; $i -lt 21600; $i++) { Start-Sleep -Seconds 1 }
      shell: powershell
