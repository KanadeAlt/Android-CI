name: Windows RDP + Cloudflare Tunnel (Automatic)

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: windows-latest

    steps:

    - name: Set RDP Password
      run: |
        net user runneradmin "Password123!"
      shell: powershell

    - name: Enable Windows RDP
      run: |
        # Enable RDP login
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" `
          -Name fDenyTSConnections -Value 0

        # Disable NLA (biar semua RDP client bisa masuk)
        Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" `
          -Name UserAuthentication -Value 0

        # Allow firewall
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
      shell: powershell

    - name: Install cloudflared
      run: choco install cloudflared -y
      shell: powershell

    - name: Start Cloudflare Tunnel (Auto)
      run: |
        echo "Starting Cloudflare tunnel..."
        Start-Process -NoNewWindow -FilePath "cloudflared" -ArgumentList "tunnel --url rdp://localhost:3389"
        Start-Sleep -Seconds 5
      shell: powershell

    - name: Show Tunnel URL
      run: |
        echo "Waiting for Cloudflare tunnel URL..."
        Start-Sleep -Seconds 10

        Get-Content "$env:USERPROFILE\.cloudflared\cloudflared.log" | Select-String "trycloudflare" -Last 1
        echo ""
        echo "==============================="
        echo "   Windows RDP is Ready!"
        echo "==============================="
        echo " Username : runneradmin"
        echo " Password : Password123!"
        echo ""
        echo "If URL not printed above, scroll up in the build logs."
      shell: powershell
